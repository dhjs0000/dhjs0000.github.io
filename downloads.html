<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>软件下载 - Ethernos Studio</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="cookie-consent.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.2.0/github-markdown.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* 版本历史模态框样式 */
        .release-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .release-modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .release-modal {
            width: 90vw;
            aspect-ratio: 16/9;
            max-height: 90vh;
            background: var(--card-bg, #1a1a2e);
            border-radius: 12px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }

        .release-modal-overlay.active .release-modal {
            transform: scale(1);
        }

        .release-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 24px;
            border-bottom: 1px solid var(--border-color, #2d2d44);
            background: var(--bg-color, #16162a);
        }

        .release-modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-color, #e4e4e7);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .release-modal-close {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: none;
            background: transparent;
            color: var(--text-muted, #a1a1aa);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .release-modal-close:hover {
            background: var(--border-color, #2d2d44);
            color: var(--text-color, #e4e4e7);
        }

        .release-modal-body {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        /* 左侧版本列表 */
        .release-list-panel {
            width: 320px;
            border-right: 1px solid var(--border-color, #2d2d44);
            display: flex;
            flex-direction: column;
            background: var(--bg-color, #16162a);
        }

        .release-list-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color, #2d2d44);
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-muted, #a1a1aa);
        }

        .release-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .release-list::-webkit-scrollbar {
            width: 6px;
        }

        .release-list::-webkit-scrollbar-track {
            background: transparent;
        }

        .release-list::-webkit-scrollbar-thumb {
            background: var(--border-color, #2d2d44);
            border-radius: 3px;
        }

        .release-item {
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 4px;
            border: 1px solid transparent;
        }

        .release-item:hover {
            background: var(--card-bg, #1a1a2e);
            border-color: var(--border-color, #2d2d44);
        }

        .release-item.active {
            background: var(--primary-color, #3b82f6);
            color: white;
        }

        .release-item.active .release-item-date,
        .release-item.active .release-item-tag {
            color: rgba(255, 255, 255, 0.8);
        }

        .release-item-version {
            font-weight: 600;
            font-size: 0.9375rem;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .release-item-date {
            font-size: 0.75rem;
            color: var(--text-muted, #a1a1aa);
            margin-bottom: 2px;
        }

        .release-item-tag {
            font-size: 0.75rem;
            color: var(--text-muted, #a1a1aa);
            font-family: monospace;
        }

        .release-item-prerelease {
            display: inline-flex;
            align-items: center;
            padding: 2px 6px;
            background: #f59e0b;
            color: #000;
            font-size: 0.625rem;
            font-weight: 600;
            border-radius: 4px;
            text-transform: uppercase;
        }

        .release-load-more {
            padding: 12px;
            text-align: center;
        }

        .release-load-more button {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color, #2d2d44);
            background: transparent;
            color: var(--text-color, #e4e4e7);
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }

        .release-load-more button:hover:not(:disabled) {
            background: var(--card-bg, #1a1a2e);
            border-color: var(--primary-color, #3b82f6);
        }

        .release-load-more button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* 右侧详情面板 */
        .release-detail-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: var(--card-bg, #1a1a2e);
        }

        .release-detail-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color, #2d2d44);
        }

        .release-detail-version {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-color, #e4e4e7);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .release-detail-meta {
            display: flex;
            gap: 16px;
            font-size: 0.875rem;
            color: var(--text-muted, #a1a1aa);
        }

        .release-detail-meta span {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .release-detail-content {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        .release-detail-content::-webkit-scrollbar {
            width: 8px;
        }

        .release-detail-content::-webkit-scrollbar-track {
            background: transparent;
        }

        .release-detail-content::-webkit-scrollbar-thumb {
            background: var(--border-color, #2d2d44);
            border-radius: 4px;
        }

        .release-assets {
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid var(--border-color, #2d2d44);
        }

        .release-assets-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-color, #e4e4e7);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .release-asset-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: var(--bg-color, #16162a);
            border-radius: 8px;
            margin-bottom: 8px;
            border: 1px solid var(--border-color, #2d2d44);
            transition: all 0.2s ease;
        }

        .release-asset-item:hover {
            border-color: var(--primary-color, #3b82f6);
        }

        .release-asset-item.recommended {
            border-color: var(--secondary-color, #10b981);
            background: rgba(16, 185, 129, 0.1);
        }

        .release-asset-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .release-asset-name {
            font-size: 0.875rem;
            color: var(--text-color, #e4e4e7);
        }

        .release-asset-size {
            font-size: 0.75rem;
            color: var(--text-muted, #a1a1aa);
        }

        .release-asset-download {
            padding: 8px 16px;
            background: var(--primary-color, #3b82f6);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.875rem;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.2s ease;
        }

        .release-asset-download:hover {
            background: var(--primary-hover, #2563eb);
        }

        .release-asset-speedup {
            padding: 8px 14px;
            background: var(--secondary-color, #10b981);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.875rem;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.2s ease;
            margin-left: 8px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .release-asset-speedup:hover {
            background: #059669;
        }

        .btn-speedup {
            background: var(--secondary-color, #10b981);
            border-color: var(--secondary-color, #10b981);
        }

        .btn-speedup:hover {
            background: #059669;
            border-color: #059669;
        }

        /* 加速加载弹窗 */
        .speedup-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10001;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .speedup-modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .speedup-modal {
            width: 560px;
            max-height: 80vh;
            background: var(--card-bg, #1a1a2e);
            border-radius: 12px;
            border: 1px solid var(--border-color, #2d2d44);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }

        .speedup-modal-overlay.active .speedup-modal {
            transform: scale(1);
        }

        .speedup-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color, #2d2d44);
            background: var(--bg-color, #16162a);
        }

        .speedup-modal-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-color, #e4e4e7);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .speedup-modal-title i {
            color: var(--secondary-color, #10b981);
        }

        .speedup-modal-close {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: none;
            background: transparent;
            color: var(--text-muted, #a1a1aa);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .speedup-modal-close:hover {
            background: var(--border-color, #2d2d44);
            color: var(--text-color, #e4e4e7);
        }

        .speedup-modal-body {
            padding: 20px 24px;
            overflow-y: auto;
            flex: 1;
        }

        .speedup-modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border-color, #2d2d44);
            background: var(--bg-color, #16162a);
            text-align: center;
        }

        .speedup-modal-footer a {
            color: var(--primary-color, #3b82f6);
            text-decoration: none;
        }

        .speedup-modal-footer a:hover {
            text-decoration: underline;
        }

        .speedup-node-item {
            padding: 16px;
            background: var(--bg-color, #16162a);
            border: 1px solid var(--border-color, #2d2d44);
            border-radius: 10px;
            margin-bottom: 12px;
            transition: all 0.2s ease;
        }

        .speedup-node-item:hover {
            border-color: var(--primary-color, #3b82f6);
        }

        .speedup-node-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .speedup-node-name {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-color, #e4e4e7);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .speedup-node-name i {
            color: var(--secondary-color, #10b981);
        }

        .speedup-node-desc {
            font-size: 0.8125rem;
            color: var(--text-muted, #a1a1aa);
            margin-bottom: 10px;
            line-height: 1.5;
        }

        .speedup-node-url {
            font-size: 0.75rem;
            color: var(--primary-color, #3b82f6);
            background: var(--card-bg, #1a1a2e);
            padding: 8px 12px;
            border-radius: 6px;
            word-break: break-all;
            margin-bottom: 10px;
            border: 1px solid var(--border-color, #2d2d44);
        }

        .speedup-node-actions {
            display: flex;
            gap: 8px;
        }

        .speedup-node-btn {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid var(--border-color, #2d2d44);
            background: transparent;
            color: var(--text-color, #e4e4e7);
            border-radius: 6px;
            font-size: 0.8125rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .speedup-node-btn:hover {
            background: var(--card-bg, #1a1a2e);
            border-color: var(--primary-color, #3b82f6);
        }

        .speedup-node-btn.primary {
            background: var(--primary-color, #3b82f6);
            border-color: var(--primary-color, #3b82f6);
            color: white;
        }

        .speedup-node-btn.primary:hover {
            background: var(--primary-hover, #2563eb);
        }

        /* Toast 提示 */
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--secondary-color, #10b981);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 0.875rem;
            z-index: 10002;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            animation: fadeInOut 2s ease;
        }

        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
            20% { opacity: 1; transform: translateX(-50%) translateY(0); }
            80% { opacity: 1; transform: translateX(-50%) translateY(0); }
            100% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
        }

        .release-asset-badge {
            display: inline-flex;
            align-items: center;
            padding: 2px 8px;
            background: var(--secondary-color, #10b981);
            color: white;
            font-size: 0.625rem;
            font-weight: 600;
            border-radius: 4px;
            margin-left: 8px;
        }

        /* 骨架屏 */
        .skeleton {
            background: linear-gradient(90deg, var(--border-color, #2d2d44) 25%, var(--card-bg, #1a1a2e) 50%, var(--border-color, #2d2d44) 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s ease-in-out infinite;
            border-radius: 4px;
        }

        @keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .release-skeleton-item {
            padding: 12px 16px;
            margin-bottom: 8px;
        }

        .release-skeleton-title {
            height: 16px;
            width: 60%;
            margin-bottom: 8px;
        }

        .release-skeleton-line {
            height: 12px;
            width: 40%;
        }

        /* 空状态 */
        .release-empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 24px;
            text-align: center;
            color: var(--text-muted, #a1a1aa);
        }

        .release-empty-state i {
            font-size: 3rem;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .release-empty-state h3 {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-color, #e4e4e7);
            margin-bottom: 8px;
        }

        /* 版本历史按钮 */
        .btn-history {
            background: transparent;
            border: 1px solid var(--border-color, #2d2d44);
            color: var(--text-muted, #a1a1aa);
        }

        .btn-history:hover {
            border-color: var(--primary-color, #3b82f6);
            color: var(--primary-color, #3b82f6);
        }

        /* 推荐下载标记 */
        .download-recommended {
            position: relative;
        }

        .download-recommended::after {
            content: '推荐';
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--secondary-color, #10b981);
            color: white;
            font-size: 0.625rem;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
        }

        /* 响应式 */
        @media (max-width: 768px) {
            .release-modal {
                width: 95vw;
                aspect-ratio: auto;
                height: 90vh;
            }

            .release-modal-body {
                flex-direction: column;
            }

            .release-list-panel {
                width: 100%;
                height: 40%;
                border-right: none;
                border-bottom: 1px solid var(--border-color, #2d2d44);
            }

            .release-detail-panel {
                height: 60%;
            }
        }
    </style>
</head>
<body>
    <div id="nav-placeholder"></div>

    <main class="content">
        <h1 class="page-title">软件下载</h1>

        <div class="asymmetric-layout">
            <!-- 左侧主要内容 -->
            <div class="main-content" id="software-container">
                <!-- 软件卡片将通过 JavaScript 动态生成 -->
                <div class="loading-state">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>正在加载软件列表...</p>
                </div>
            </div>

            <!-- 右侧侧边栏 -->
            <aside class="sidebar">
                <div class="sidebar-section">
                    <h3>快速链接</h3>
                    <ul class="list-group" id="quick-links">
                        <!-- 动态生成 -->
                    </ul>
                </div>

                <div class="sidebar-section">
                    <h3>版本历史</h3>
                    <div class="timeline" id="version-timeline">
                        <!-- 动态生成 -->
                    </div>
                </div>

                <div class="sidebar-section">
                    <h3>标签</h3>
                    <div id="tags-container">
                        <span class="tag">编程语言</span>
                        <span class="tag">Blender</span>
                        <span class="tag">开源</span>
                        <span class="tag">工具</span>
                    </div>
                </div>
            </aside>
        </div>
    </main>

    <footer class="footer">
        <div class="footer-container">
            <div class="footer-links">
                <div class="footer-section">
                    <h3>项目</h3>
                    <a href="https://ethernos.cn/bccWeb/">BCC语言</a>
                </div>
                <div class="footer-section">
                    <h3>资源</h3>
                    <a href="downloads.html">软件下载</a>
                    <a href="tools.html">开发工具</a>
                </div>
                <div class="footer-section">
                    <h3>服务</h3>
                    <a href="blog.html">技术博客</a>
                    <a href="questions.html">技术支持</a>
                </div>
                <div class="footer-section">
                    <h3>关于</h3>
                    <a href="team.html">团队</a>
                    <a href="contact.html">联系我们</a>
                </div>
            </div>
            <div class="footer-bottom">
                <p>Copyright (C) 2026 Ethernos</p>
                <p>本程序为自由软件，在自由软件联盟发布的GNU通用公共许可协议的约束下，你可以对其进行再发布及修改。协议版本为第三版或（随你）更新的版本。</p>
                <p>我们希望发布的这个网站有用，但不保证，甚至不保证它有经济价值和适合特定用途。详情参见GNU通用公共许可协议。</p>

                <p>This program is free software: you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version.</p>
                <p>This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.</p>
                <p>You should have received a copy of the GNU General Public License along with this program. If not, see <a href="https://www.gnu.org/licenses/">https://www.gnu.org/licenses/</a>.</p>
            </div>
        </div>
    </footer>

    <!-- 加速加载弹窗 -->
    <div class="speedup-modal-overlay" id="speedupModal">
        <div class="speedup-modal">
            <div class="speedup-modal-header">
                <div class="speedup-modal-title">
                    <i class="fas fa-rocket"></i>
                    <span>选择加速节点</span>
                </div>
                <button class="speedup-modal-close" onclick="closeSpeedupModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="speedup-modal-body" id="speedupModalBody">
                <!-- 动态生成节点列表 -->
            </div>
            <div class="speedup-modal-footer">
                <span style="color: var(--text-muted); font-size: 0.8125rem;">
                    <i class="fas fa-heart" style="color: #ef4444;"></i>
                    感谢 <a href="https://gh-proxy.com" target="_blank">gh-proxy.com</a> 提供加速服务，前往这个网站可以支持他们
                </span>
            </div>
        </div>
    </div>

    <!-- 版本历史模态框 -->
    <div class="release-modal-overlay" id="releaseModal">
        <div class="release-modal">
            <div class="release-modal-header">
                <div class="release-modal-title">
                    <i class="fas fa-code-branch"></i>
                    <span id="modalSoftwareName">版本历史</span>
                </div>
                <button class="release-modal-close" onclick="closeReleaseModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="release-modal-body">
                <div class="release-list-panel">
                    <div class="release-list-header">
                        <i class="fas fa-list"></i> 版本列表
                    </div>
                    <div class="release-list" id="releaseList">
                        <!-- 动态生成 -->
                    </div>
                </div>
                <div class="release-detail-panel">
                    <div class="release-detail-content" id="releaseDetail">
                        <div class="release-empty-state">
                            <i class="fas fa-arrow-left"></i>
                            <h3>选择版本查看详情</h3>
                            <p>从左侧列表选择一个版本以查看详细信息</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
    <script src="config.js"></script>
    <script>
        // 全局软件配置存储
        let softwareConfigs = {};

        // 检测用户操作系统
        function getUserPlatform() {
            const ua = navigator.userAgent.toLowerCase();
            if (ua.includes('win')) return 'windows';
            if (ua.includes('mac') || ua.includes('darwin')) return 'macos';
            if (ua.includes('linux')) return 'linux';
            return 'unknown';
        }

        // 语义分析引擎 - 分析单个 Asset
        function analyzeAsset(asset, config = {}) {
            const filename = asset.name.toLowerCase();
            const defaultConfig = {
                priority_patterns: [],
                ignore_patterns: ['runtime', 'deps', 'dependencies', 'source', 'src', 'docs', 'test', 'debug'],
                platform_keywords: {
                    windows: ['windows', 'win', 'win32', 'win64', 'amd64-windows', 'x86_64-windows', '.exe', '.msi', '.zip'],
                    macos: ['mac', 'macos', 'darwin', 'osx', '.dmg', '.app', '.pkg'],
                    linux: ['linux', 'appimage', '.deb', '.rpm', '.tar.gz', '.tar.xz', '.AppImage']
                }
            };
            
            const cfg = { ...defaultConfig, ...config };
            const userPlatform = getUserPlatform();
            
            let score = 0;
            const reasons = [];
            
            // 1. 忽略模式检查（大幅降分）
            for (const pattern of cfg.ignore_patterns) {
                if (filename.includes(pattern.toLowerCase())) {
                    score -= 50;
                    reasons.push(`忽略模式匹配: ${pattern}`);
                }
            }
            
            // 2. 优先模式检查（高权重加分）
            for (const pattern of cfg.priority_patterns) {
                if (filename.includes(pattern.toLowerCase())) {
                    score += 30;
                    reasons.push(`优先模式匹配: ${pattern}`);
                }
            }
            
            // 3. 版本号检测（主程序包特征）
            const versionPattern = /v?\d+\.\d+\.?\d*/;
            if (versionPattern.test(filename)) {
                score += 20;
                reasons.push('包含版本号');
            }
            
            // 4. 平台匹配（根据用户系统）
            let platformMatch = false;
            for (const [platform, keywords] of Object.entries(cfg.platform_keywords)) {
                for (const keyword of keywords) {
                    if (filename.includes(keyword.toLowerCase())) {
                        if (platform === userPlatform) {
                            score += 25;
                            platformMatch = true;
                            reasons.push(`匹配当前平台: ${platform}`);
                        } else {
                            score += 5;
                            reasons.push(`支持平台: ${platform}`);
                        }
                        break;
                    }
                }
            }
            
            // 5. 架构信息检测
            const archPatterns = ['amd64', 'x86_64', 'x64', 'i386', 'i686', 'x86', 'arm64', 'aarch64'];
            for (const arch of archPatterns) {
                if (filename.includes(arch)) {
                    score += 10;
                    reasons.push(`架构信息: ${arch}`);
                    break;
                }
            }
            
            // 6. 文件类型评分
            if (filename.endsWith('.exe') || filename.endsWith('.msi')) {
                score += 15;
                reasons.push('Windows安装包');
            } else if (filename.endsWith('.dmg') || filename.endsWith('.pkg')) {
                score += 15;
                reasons.push('macOS安装包');
            } else if (filename.endsWith('.appimage') || filename.endsWith('.deb') || filename.endsWith('.rpm')) {
                score += 15;
                reasons.push('Linux安装包');
            } else if (filename.endsWith('.zip') || filename.endsWith('.tar.gz')) {
                score += 5;
                reasons.push('压缩包');
            }
            
            // 7. 文件名长度惩罚（过长可能是源码包）
            if (filename.length > 50) {
                score -= 5;
                reasons.push('文件名过长');
            }
            
            return {
                score,
                reasons,
                platformMatch,
                confidence: Math.min(Math.abs(score) / 100, 1)
            };
        }

        // 获取推荐的下载 Asset
        function getRecommendedAsset(assets, config = {}) {
            if (!assets || assets.length === 0) return null;
            
            // 为每个 Asset 评分
            const scored = assets.map(asset => ({
                asset,
                analysis: analyzeAsset(asset, config)
            }));
            
            // 按分数排序
            scored.sort((a, b) => b.analysis.score - a.analysis.score);
            
            // 返回最高分的 Asset
            const best = scored[0];
            if (best.analysis.score < -20) {
                // 置信度太低，返回第一个原始 Asset
                return { asset: assets[0], analysis: { score: 0, confidence: 0, reasons: ['默认选择'], isFallback: true } };
            }
            
            return best;
        }

        // 按优先级排序所有 Assets
        function sortAssetsByPriority(assets, config = {}) {
            if (!assets || assets.length === 0) return [];
            
            return assets.map(asset => ({
                asset,
                analysis: analyzeAsset(asset, config)
            })).sort((a, b) => b.analysis.score - a.analysis.score);
        }

        // 格式化日期
        function formatDate(dateString) {
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('zh-CN', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            } catch (error) {
                return dateString;
            }
        }

        // 格式化文件大小
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // 获取请求头
        function getHeaders() {
            const headers = {
                'Accept': 'application/vnd.github.v3+json'
            };
            if (typeof config !== 'undefined' && config.githubToken &&
                config.githubToken !== 'ghp_YOUR_TOKEN_HERE' &&
                config.githubToken.startsWith('ghp_')) {
                headers.Authorization = `token ${config.githubToken}`;
            }
            return headers;
        }

        // 创建软件卡片
        function createSoftwareCard(software, index) {
            const cardClass = index === 0 ? 'card-highlight' : (index % 2 === 0 ? 'card-success' : 'card-info');
            const icon = software.icon || 'fa-box';
            const features = software.features || ['功能强大', '易于使用', '开源免费'];
            const softwareId = software.name.replace(/\s+/g, '-').toLowerCase();
            
            // 保存配置
            softwareConfigs[softwareId] = software.asset_config || {};

            return `
                <div class="info-panel ${cardClass}" id="card-${softwareId}" style="${index > 0 ? 'margin-top: 24px;' : ''}">
                    <div class="info-panel-header">
                        <i class="fas ${icon}"></i>
                        <h2>${software.name}</h2>
                    </div>
                    <p>${software.description}</p>
                    
                    <div class="version-info" style="display: flex; gap: 24px; margin: 16px 0; padding: 16px; background: var(--bg-color); border-radius: 6px;">
                        <div>
                            <i class="fas fa-code-branch" style="color: var(--primary-color);"></i>
                            <span id="${softwareId}-version" style="margin-left: 8px; font-family: monospace;">获取中...</span>
                        </div>
                        <div>
                            <i class="far fa-calendar-alt" style="color: var(--text-muted);"></i>
                            <span id="${softwareId}-date" style="margin-left: 8px; color: var(--text-muted);">获取中...</span>
                        </div>
                    </div>

                    <ul style="list-style: none; padding: 0; margin: 16px 0;">
                        ${features.map((f, i) => `
                            <li style="padding: 8px 0; ${i < features.length - 1 ? 'border-bottom: 1px solid var(--border-color);' : ''}">
                                <i class="fas fa-check" style="color: var(--secondary-color); margin-right: 8px;"></i>${f}
                            </li>
                        `).join('')}
                    </ul>

                    <div class="release-notes" id="${softwareId}-notes" style="margin: 16px 0; padding: 16px; background: var(--bg-color); border-radius: 6px;">
                        <h3 style="margin: 0 0 12px 0; font-size: 0.875rem; color: var(--text-muted);">更新说明</h3>
                        <p style="margin: 0; color: var(--text-muted);">正在从 GitHub 获取...</p>
                    </div>

                    <div class="button-group" style="justify-content: flex-start;">
                        <a href="#" id="${softwareId}-download" class="button download-recommended" target="_blank">
                            <i class="fas fa-download"></i> 下载
                        </a>
                        <button class="button btn-speedup" id="${softwareId}-speedup" onclick="openSpeedupModalForSoftware('${softwareId}')">
                            <i class="fas fa-rocket"></i> 快速下载
                        </button>
                        <button class="button outline btn-history" onclick="openReleaseModal('${software.name}', '${software.relatively_url}')">
                            <i class="fas fa-history"></i> 版本历史
                        </button>
                        ${software.web_url ? `
                            <a href="${software.web_url}" class="button outline" target="_blank">
                                <i class="fas fa-globe"></i> 官网
                            </a>
                        ` : ''}
                        <a href="${software.repo_url}" class="button outline" target="_blank">
                            <i class="fab fa-github"></i> GitHub
                        </a>
                    </div>
                </div>
            `;
        }

        // 获取最新版本信息
        async function fetchReleaseInfo(software) {
            const softwareId = software.name.replace(/\s+/g, '-').toLowerCase();
            const versionEl = document.getElementById(`${softwareId}-version`);
            const dateEl = document.getElementById(`${softwareId}-date`);
            const notesEl = document.getElementById(`${softwareId}-notes`);
            const downloadBtn = document.getElementById(`${softwareId}-download`);
            const assetConfig = softwareConfigs[softwareId] || {};

            downloadBtn.href = `${software.repo_url}/releases`;
            downloadBtn.innerHTML = `<i class="fas fa-download"></i> 前往下载`;
            downloadBtn.classList.remove('download-recommended');

            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 3000);

                const response = await fetch(
                    `https://api.github.com/repos/${software.relatively_url}/releases/latest`,
                    { headers: getHeaders(), signal: controller.signal }
                );

                clearTimeout(timeoutId);

                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const data = await response.json();

                versionEl.textContent = data.tag_name || '未知版本';
                dateEl.textContent = formatDate(data.published_at) || '未知日期';

                const notes = data.body ? marked.parse(data.body) : '暂无更新说明';
                notesEl.innerHTML = `
                    <h3 style="margin: 0 0 12px 0; font-size: 0.875rem; color: var(--text-muted);">更新说明</h3>
                    <div class="markdown-body" style="color: var(--text-muted);">${notes}</div>
                `;

                // 使用智能推荐算法选择下载文件
                if (data.assets && data.assets.length > 0) {
                    const recommended = getRecommendedAsset(data.assets, assetConfig);
                    if (recommended && recommended.asset) {
                        downloadBtn.href = recommended.asset.browser_download_url;
                        downloadBtn.innerHTML = `<i class="fas fa-download"></i> 下载 ${data.tag_name}`;
                        if (recommended.analysis.confidence > 0.3) {
                            downloadBtn.classList.add('download-recommended');
                        }
                        // 存储下载URL用于加速
                        softwareDownloadUrls[softwareId] = recommended.asset.browser_download_url;
                    } else {
                        downloadBtn.href = data.html_url;
                        downloadBtn.innerHTML = `<i class="fas fa-download"></i> 下载 ${data.tag_name}`;
                    }
                } else {
                    downloadBtn.href = data.html_url;
                    downloadBtn.innerHTML = `<i class="fas fa-download"></i> 下载 ${data.tag_name}`;
                }

            } catch (error) {
                console.log(`${software.name} 版本信息获取失败:`, error.message);
                versionEl.textContent = '请查看 GitHub';
                dateEl.textContent = '请查看 GitHub';
                notesEl.innerHTML = `
                    <h3 style="margin: 0 0 12px 0; font-size: 0.875rem; color: var(--text-muted);">更新说明</h3>
                    <p style="margin: 0; color: var(--text-muted);">
                        无法获取最新版本信息，请前往 GitHub 查看详情。
                    </p>
                `;
            }
        }

        // 版本历史模态框状态
        let currentModalRepo = null;
        let currentModalPage = 1;
        let modalReleases = [];
        let selectedReleaseIndex = -1;

        // 打开版本历史模态框
        async function openReleaseModal(softwareName, repoUrl) {
            currentModalRepo = repoUrl;
            currentModalPage = 1;
            modalReleases = [];
            selectedReleaseIndex = -1;

            document.getElementById('modalSoftwareName').textContent = `${softwareName} - 版本历史`;
            document.getElementById('releaseModal').classList.add('active');
            document.body.style.overflow = 'hidden';

            showSkeletonLoading();
            await loadMoreReleases();
        }

        // 关闭版本历史模态框
        function closeReleaseModal() {
            document.getElementById('releaseModal').classList.remove('active');
            document.body.style.overflow = '';
            currentModalRepo = null;
            modalReleases = [];
        }

        // 显示骨架屏
        function showSkeletonLoading() {
            const releaseList = document.getElementById('releaseList');
            releaseList.innerHTML = Array(5).fill(0).map(() => `
                <div class="release-skeleton-item">
                    <div class="skeleton release-skeleton-title"></div>
                    <div class="skeleton release-skeleton-line"></div>
                </div>
            `).join('');

            document.getElementById('releaseDetail').innerHTML = `
                <div class="release-empty-state">
                    <i class="fas fa-spinner fa-spin"></i>
                    <h3>正在加载版本历史...</h3>
                </div>
            `;
        }

        // 加载更多版本
        async function loadMoreReleases() {
            if (!currentModalRepo) return;

            const perPage = 10;
            const releaseList = document.getElementById('releaseList');

            const loadMoreBtn = releaseList.querySelector('.release-load-more');
            if (loadMoreBtn) loadMoreBtn.remove();

            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000);

                const response = await fetch(
                    `https://api.github.com/repos/${currentModalRepo}/releases?page=${currentModalPage}&per_page=${perPage}`,
                    { headers: getHeaders(), signal: controller.signal }
                );

                clearTimeout(timeoutId);

                if (!response.ok) {
                    if (response.status === 404) {
                        showEmptyState('暂无发布历史', '该仓库尚未创建任何 Release');
                        return;
                    }
                    throw new Error(`HTTP ${response.status}`);
                }

                const releases = await response.json();

                if (releases.length === 0 && currentModalPage === 1) {
                    showEmptyState('暂无发布历史', '该仓库尚未创建任何 Release');
                    return;
                }

                if (currentModalPage === 1) {
                    releaseList.innerHTML = '';
                }

                const startIndex = modalReleases.length;
                modalReleases.push(...releases);

                releases.forEach((release, index) => {
                    const actualIndex = startIndex + index;
                    const item = document.createElement('div');
                    item.className = 'release-item';
                    item.dataset.index = actualIndex;
                    item.onclick = () => selectRelease(actualIndex);
                    item.innerHTML = `
                        <div class="release-item-version">
                            ${release.name || release.tag_name}
                            ${release.prerelease ? '<span class="release-item-prerelease">Pre-release</span>' : ''}
                        </div>
                        <div class="release-item-date">${formatDate(release.published_at)}</div>
                        <div class="release-item-tag">${release.tag_name}</div>
                    `;
                    releaseList.appendChild(item);
                });

                if (releases.length === perPage) {
                    const loadMoreDiv = document.createElement('div');
                    loadMoreDiv.className = 'release-load-more';
                    loadMoreDiv.innerHTML = `
                        <button onclick="loadMoreReleases()">
                            <i class="fas fa-chevron-down"></i> 加载更多
                        </button>
                    `;
                    releaseList.appendChild(loadMoreDiv);
                }

                currentModalPage++;

                if (currentModalPage === 2 && modalReleases.length > 0) {
                    selectRelease(0);
                }

            } catch (error) {
                console.error('加载版本历史失败:', error);
                if (currentModalPage === 1) {
                    showEmptyState('加载失败', '无法获取版本历史，请稍后重试');
                }
            }
        }

        // 显示空状态
        function showEmptyState(title, message) {
            document.getElementById('releaseList').innerHTML = `
                <div class="release-empty-state" style="padding: 40px 20px;">
                    <i class="fas fa-inbox"></i>
                    <h3>${title}</h3>
                    <p>${message}</p>
                </div>
            `;
            document.getElementById('releaseDetail').innerHTML = '';
        }

        // 选择版本
        function selectRelease(index) {
            if (index < 0 || index >= modalReleases.length) return;

            selectedReleaseIndex = index;
            const release = modalReleases[index];
            
            // 获取软件配置（从 repoUrl 推断 softwareId）
            let assetConfig = {};
            for (const [id, cfg] of Object.entries(softwareConfigs)) {
                if (currentModalRepo && currentModalRepo.includes(id.replace(/-/g, '').toLowerCase())) {
                    assetConfig = cfg;
                    break;
                }
            }

            document.querySelectorAll('.release-item').forEach(item => {
                item.classList.toggle('active', parseInt(item.dataset.index) === index);
            });

            // 使用智能排序显示 Assets
            const sortedAssets = release.assets && release.assets.length > 0 
                ? sortAssetsByPriority(release.assets, assetConfig)
                : [];
            
            const topScore = sortedAssets.length > 0 ? sortedAssets[0].analysis.score : 0;

            const detailPanel = document.getElementById('releaseDetail');
            detailPanel.innerHTML = `
                <div class="release-detail-header">
                    <div class="release-detail-version">
                        ${release.name || release.tag_name}
                        ${release.prerelease ? '<span class="release-item-prerelease">Pre-release</span>' : ''}
                    </div>
                    <div class="release-detail-meta">
                        <span><i class="fas fa-tag"></i> ${release.tag_name}</span>
                        <span><i class="fas fa-calendar"></i> ${formatDate(release.published_at)}</span>
                        <span><i class="fas fa-user"></i> ${release.author.login}</span>
                    </div>
                </div>
                <div class="release-detail-content">
                    <div class="markdown-body">
                        ${release.body ? marked.parse(release.body) : '<p style="color: var(--text-muted);">暂无更新说明</p>'}
                    </div>
                    ${sortedAssets.length > 0 ? `
                        <div class="release-assets">
                            <div class="release-assets-title">
                                <i class="fas fa-box-archive"></i> 下载资源 (${sortedAssets.length})
                            </div>
                            ${sortedAssets.map(({asset, analysis}, idx) => {
                                const isRecommended = idx === 0 && analysis.score > 0 && analysis.confidence > 0.3;
                                return `
                                <div class="release-asset-item ${isRecommended ? 'recommended' : ''}">
                                    <div class="release-asset-info">
                                        <i class="fas fa-file-archive" style="color: ${isRecommended ? 'var(--secondary-color)' : 'var(--primary-color)'};"></i>
                                        <div>
                                            <div class="release-asset-name">
                                                ${asset.name}
                                                ${isRecommended ? '<span class="release-asset-badge">推荐</span>' : ''}
                                            </div>
                                            <div class="release-asset-size">${formatFileSize(asset.size)} · ${asset.download_count} 次下载</div>
                                        </div>
                                    </div>
                                    <div>
                                        <a href="${asset.browser_download_url}" class="release-asset-download" target="_blank">
                                            <i class="fas fa-download"></i> 下载
                                        </a>
                                        <button class="release-asset-speedup" onclick="openSpeedupModal('${asset.browser_download_url}')">
                                            <i class="fas fa-rocket"></i> 加速
                                        </button>
                                    </div>
                                </div>
                            `}).join('')}
                        </div>
                    ` : '<div class="release-empty-state" style="padding: 40px 0;"><i class="fas fa-box-open"></i><h3>无下载资源</h3><p>该版本未包含可下载的文件</p></div>'}
                </div>
            `;

            const selectedItem = document.querySelector(`.release-item[data-index="${index}"]`);
            if (selectedItem) {
                selectedItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }

        // 加速节点配置
        const speedupNodes = [
            {
                name: 'cloudflare',
                icon: 'fa-cloud',
                desc: '主站，全球加速！国内优选和V6支持请使用：https://v6.gh-proxy.org/',
                prefix: 'https://gh-proxy.org/'
            },
            {
                name: '香港',
                icon: 'fa-building',
                desc: '国内线路优化,secbit.ai&Sharon CDN赞助(大文件下载不建议使用！)',
                prefix: 'https://hk.gh-proxy.org/'
            },
            {
                name: 'Fastly',
                icon: 'fa-bolt',
                desc: 'Fastly CDN',
                prefix: 'https://cdn.gh-proxy.org/'
            },
            {
                name: 'edgeone',
                icon: 'fa-globe',
                desc: '全球加速，数据统计',
                prefix: 'https://edgeone.gh-proxy.org/'
            }
        ];

        // 存储每个软件的下载URL
        let softwareDownloadUrls = {};

        // 打开加速弹窗
        function openSpeedupModal(originalUrl) {
            const modalBody = document.getElementById('speedupModalBody');
            modalBody.innerHTML = speedupNodes.map(node => {
                const speedupUrl = node.prefix + originalUrl;
                return `
                    <div class="speedup-node-item">
                        <div class="speedup-node-header">
                            <span class="speedup-node-name"><i class="fas ${node.icon}"></i> ${node.name}</span>
                        </div>
                        <div class="speedup-node-desc">${node.desc}</div>
                        <div class="speedup-node-url">${speedupUrl}</div>
                        <div class="speedup-node-actions">
                            <button class="speedup-node-btn" onclick="copySpeedupUrl('${speedupUrl}')"><i class="fas fa-copy"></i> 复制</button>
                            <button class="speedup-node-btn primary" onclick="openSpeedupUrl('${speedupUrl}')"><i class="fas fa-external-link-alt"></i> 打开</button>
                        </div>
                    </div>
                `;
            }).join('');
            document.getElementById('speedupModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        // 为软件卡片打开加速弹窗
        function openSpeedupModalForSoftware(softwareId) {
            const downloadUrl = softwareDownloadUrls[softwareId];
            if (downloadUrl && downloadUrl.includes('github.com')) {
                openSpeedupModal(downloadUrl);
            } else {
                showToast('暂无可加速的下载链接');
            }
        }

        // 关闭加速弹窗
        function closeSpeedupModal() {
            document.getElementById('speedupModal').classList.remove('active');
            document.body.style.overflow = '';
        }

        // 点击遮罩层关闭
        document.getElementById('speedupModal').addEventListener('click', (e) => {
            if (e.target.id === 'speedupModal') {
                closeSpeedupModal();
            }
        });

        // 复制加速链接
        function copySpeedupUrl(url) {
            navigator.clipboard.writeText(url).then(() => {
                showToast('链接已复制到剪贴板');
            }).catch(() => {
                // 降级方案
                const input = document.createElement('input');
                input.value = url;
                document.body.appendChild(input);
                input.select();
                document.execCommand('copy');
                document.body.removeChild(input);
                showToast('链接已复制到剪贴板');
            });
        }

        // 打开加速链接
        function openSpeedupUrl(url) {
            window.open(url, '_blank');
        }

        // 显示提示
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2000);
        }

        // 更新侧边栏快速链接
        function updateSidebar(softwares) {
            const quickLinksEl = document.getElementById('quick-links');
            quickLinksEl.innerHTML = softwares.map(s => `
                <li class="list-group-item">
                    <a href="${s.repo_url}" target="_blank">
                        <i class="fab fa-github"></i> ${s.name}
                    </a>
                </li>
            `).join('');
        }

        // 初始化页面
        async function init() {
            const container = document.getElementById('software-container');

            try {
                const response = await fetch('softs.json');
                if (!response.ok) {
                    throw new Error(`Failed to load softs.json: ${response.status}`);
                }

                const softwares = await response.json();

                if (!Array.isArray(softwares) || softwares.length === 0) {
                    throw new Error('软件列表为空');
                }

                container.innerHTML = softwares.map((s, i) => createSoftwareCard(s, i)).join('');
                updateSidebar(softwares);

                softwares.forEach(software => {
                    fetchReleaseInfo(software);
                });

            } catch (error) {
                console.error('加载软件列表失败:', error);
                container.innerHTML = `
                    <div class="error-state" style="text-align: center; padding: 40px; color: var(--text-muted);">
                        <i class="fas fa-exclamation-circle" style="font-size: 3rem; margin-bottom: 16px; color: var(--danger-color);"></i>
                        <h3>加载失败</h3>
                        <p>无法加载软件列表，请刷新页面重试。</p>
                        <p style="font-size: 0.875rem; margin-top: 8px;">${error.message}</p>
                    </div>
                `;
            }
        }

        // ESC 关闭模态框
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeReleaseModal();
                closeSpeedupModal();
            }
        });

        // 点击遮罩层关闭
        document.getElementById('releaseModal').addEventListener('click', (e) => {
            if (e.target.id === 'releaseModal') {
                closeReleaseModal();
            }
        });

        // 页面加载完成后初始化
        window.addEventListener('DOMContentLoaded', init);
    </script>
    <script src="cookie-consent.js"></script>
</body>
</html>
